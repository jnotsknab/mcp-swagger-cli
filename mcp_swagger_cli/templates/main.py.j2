"""{{ title }} - Generated MCP Server.

This MCP server was generated from an OpenAPI specification and provides
access to the {{ title }} API via the Model Context Protocol.

Generated by: mcp-swagger-cli
Server Name: {{ server_name }}
Version: {{ version }}
Transport: {{ transport }}

{% if description %}
{{ description }}
{% endif %}
"""

import asyncio
import json
from pathlib import Path
from typing import Any

import httpx
from mcp.server.fastmcp import FastMCP

# Server configuration
SERVER_NAME = "{{ server_name }}"
BASE_URL = "{{ base_url }}"

# Create the MCP server
mcp = FastMCP(
    name=SERVER_NAME,
    json_response=True,
)

# HTTP client for API calls
_http_client: httpx.AsyncClient | None = None


async def get_http_client() -> httpx.AsyncClient:
    """Get or create the HTTP client."""
    global _http_client
    if _http_client is None:
        _http_client = httpx.AsyncClient(
            base_url=BASE_URL,
            timeout=30.0,
            follow_redirects=True,
        )
    return _http_client


async def close_http_client() -> None:
    """Close the HTTP client."""
    global _http_client
    if _http_client is not None:
        await _http_client.aclose()
        _http_client = None


{% for operation in operations %}
{% set params = operation.parameters %}
{% set has_params = params | length > 0 %}
{% set has_body = operation.request_body is not none %}
{% set func_name = operation.operation_id | sanitize_name %}


@mcp.tool()
async def {{ func_name }}(
    {%- for param in params | sort_params %}
    {{ param.name }}: {{ param.type | to_python_type }}{% if not param.required %} = None{% endif %},
    {%- endfor %}
{% if has_body and operation.request_body.schema %}
    body: dict[str, Any] = {},
{% endif %}
) -> dict[str, Any]:
    """{{ operation.summary | escape_docstring }}
    
    {% if operation.description %}
    {{ operation.description | escape_docstring }}
    {% endif %}
    
    {% if operation.deprecated %}
    .. deprecated::
    {% endif %}
    
    {% if has_params %}
    Args:
        {%- for param in params %}
        {{ param.name }}: {{ param.description or 'Parameter' }}{% if param.required %} (required){% endif %}
        {%- endfor %}
    {% endif %}
    
    {% if has_body %}
    Args:
        body: Request body (JSON)
    {% endif %}
    
    Returns:
        API response as dictionary
    """
    client = await get_http_client()
    
    {% if has_params %}
    # Build query parameters
    params = {
        {%- for param in params %}
        {% if param.in == 'query' %}
        "{{ param.name }}": {{ param.name }},
        {% endif %}
        {%- endfor %}
    }
    {% else %}
    params = None
    {% endif %}
    
    {% if has_body %}
    # Use body for request body
    json_data = body
    {% else %}
    json_data = None
    {% endif %}
    
    try:
        response = await client.request(
            method="{{ operation.method | upper }}",
            url="{{ operation.path }}",
            params=params,
            json=json_data,
        )
        response.raise_for_status()
        return response.json()
    except httpx.HTTPStatusError as e:
        return {
            "error": True,
            "status_code": e.response.status_code,
            "message": str(e),
            "response": e.response.text,
        }
    except Exception as e:
        return {
            "error": True,
            "message": str(e),
        }


{% endfor %}

{% if schemas %}
@mcp.resource("schema://api/schemas")
async def get_api_schemas() -> str:
    """Get all available API schemas."""
    schemas = {{ schema_names | tojson }}
    return json.dumps({
        "schemas": schemas,
        "count": len(schemas),
    })


{% for schema_name in schema_names %}
@mcp.resource("schema://api/{{ schema_name | lower }}")
async def get_schema_{{ schema_name | sanitize_name }}() -> str:
    """Get the {{ schema_name }} schema definition."""
    schema = {{ schemas | tojson }}.get("{{ schema_name }}", {})
    return json.dumps(schema, indent=2)


{% endfor %}
{% endif %}

{% if operations %}
@mcp.resource("api://operations")
async def get_api_operations() -> str:
    """Get list of all available API operations."""
    operations = [
        {% for operation in operations %}
        {
            "operation_id": "{{ operation.operation_id }}",
            "method": "{{ operation.method }}",
            "path": "{{ operation.path }}",
            "summary": "{{ operation.summary | escape_docstring }}",
            "tags": {{ operation.tags | tojson }},
        },
        {% endfor %}
    ]
    return json.dumps({
        "operations": operations,
        "count": len(operations),
    }, indent=2)


{% endif %}

def main() -> None:
    """Main entry point for the MCP server."""
    import sys
    
    # Parse transport from command line
    transport = "stdio"
    port = 8000
    
    if len(sys.argv) > 1:
        if sys.argv[1] == "--sse" or sys.argv[1] == "--http":
            transport = "sse"
        if len(sys.argv) > 2 and sys.argv[2].isdigit():
            port = int(sys.argv[2])
    
    if transport == "sse":
        # Run with SSE transport
        import uvicorn
        print(f"Starting {SERVER_NAME} on port {port}...")
        uvicorn.run(mcp.streamable_http_app, host="0.0.0.0", port=port)
    else:
        # Run with stdio transport (default)
        print(f"Starting {SERVER_NAME} with stdio transport...")
        mcp.run()


if __name__ == "__main__":
    main()
